#!/usr/sbin/nft -f

flush ruleset

define clientLanHq = 192.168.10.0/24
define externalDmz = 10.0.50.0/24
define internalDmz = 10.0.60.0/24
define allInternalLans = {$clientLanHq, $externalDmz, $internalDmz}
define dnsServer = 91.219.71.254

# Early stateless filtering on the NIC
table netdev filter {
    set blacklist_ips {
        type ipv4_addr
        flags interval, auto-merge;
    }

    set bogus {
        type ipv4_addr;
        flags interval;
        elements = {
        0.0.0.0/8,
        10.0.0.0/8,
        100.64.0.0/10,
        127.0.0.0/8,
        169.254.0.0/16,
        172.16.0.0/12,
        192.0.0.0/24,
        192.0.2.0/24,
        192.168.0.0/16,
        198.18.0.0/15,
        198.51.100.0/24,
        203.0.113.0/24,
        224.0.0.0/3
    }
  }
  chain BOGUS {
    type filter hook ingress device "ens33" priority -500;

    #ip frag-off & 0x1fff != 0 counter drop       # IP fragments
    ip saddr @bogus counter drop                 # Bogon / martian sources

    tcp flags & (fin|psh|urg) == fin|psh|urg counter drop      # TCP XMAS
    tcp flags & (fin|syn|rst|psh|ack|urg) == 0x0 counter drop  # TCP NULL

    tcp flags syn tcp option maxseg size 1-535 counter drop    # Tiny MSS
    # ancient RFCs define 536 bytes as the minimum sane TCP MSS

    ip daddr @blacklist_ips counter drop; # blacklist dropping
  }
}

table inet filter {

    set ntpServers { # [7] might be updated with script (see below) periodically
        type ipv4_addr
        elements = { 131.130.250.250 }
    }

    set debianRepositories { # [10] might be updated with script (below) period.
        type ipv4_addr
        elements = { 151.101.130.132, 151.101.2.132, 151.101.66.132, 151.101.194.132 }
    }
    set https_server_ratelimit {
        type ipv4_addr
        timeout 60s
        flags dynamic
    }
    chain prerouting {
      type filter hook prerouting priority -150;
  
      ct state invalid counter drop    # CT INVALID
  
      # New TCP connections must start with a clean SYN
      tcp flags & (fin|syn|rst|ack) != syn ct state new counter drop
    }
	chain input {
        # [14] silently drop any other packets
        type filter hook input priority filter; policy drop;
    
        # drop any invalid traffic as first measure
        ct state invalid drop
        # allow any packets belonging to existing connections
        ct state established accept
        
        # [2] [4] allow icmp messages related to existing connections
        ip protocol icmp ct state related accept
        
        # [1] allow any traffic on loopback not to break local applications
        iifname "lo" accept
        
        # [3] allow ssh on fw-hq only from client hq
        ip protocol tcp ip saddr 192.168.10.1 tcp dport 22 ct state new accept
        
        # [4] allow firewall to be pinged from internal net and dmz
        ip protocol icmp ip saddr $allInternalLans icmp type echo-request accept

        # [13] log any other packets for debugging and monitoring vgl. folie 69/71
        limit rate 1/second burst 5 packets log prefix "INPUT-drop: "
	}

	chain forward {
        # [14] silently drop any other packets
            type filter hook forward priority filter; policy drop;
    
        # drop any invalid traffic as first measure
        ct state invalid drop
        # allow any packets belonging to existing connections
        ct state established accept
    
        # [5] allow DNS-Requests from internal-lans, [6] adapted for tcp AND udp
        ip protocol {udp, tcp} ip saddr $allInternalLans ip daddr $dnsServer th dport 53 ct state new accept

        # [8] allow HTTP/HTTPS requests from int.lans, [9] adapted for HTTP3 (+udp)
        ip protocol {udp, tcp} ip saddr $clientLanHq th dport {80, 443} ct state new accept

        # [10] allow HTTP/HTTPS requests from dmzs only to debian repos
        ip protocol tcp ip saddr {$externalDmz,$internalDmz} ip daddr @debianRepositories tcp dport {80, 443} ct state new accept
        
        # [11] allow HTTP/HTTPS to dmz from internet
        #ip protocol tcp ip daddr {10.0.50.1, 10.0.50.2} tcp dport {80,443} ct state new accept
        # Adapted [11] with rate limiting
        ip protocol tcp ip daddr {10.0.50.1, 10.0.50.2} tcp dport {80} ct state new accept
        ip protocol tcp ip daddr 10.0.50.2 tcp dport {443} ct state new accept
        ip protocol tcp ip daddr 10.0.50.1 tcp dport {443} ct state new update @https_server_ratelimit { ip saddr limit rate 25/minute } accept 
        # [12] allow TCP8080 from client-LAN to server-dmz2
        ip protocol tcp ip saddr $clientLanHq ip daddr 10.0.50.2 tcp dport 8080 ct state new accept

        # [Added with server-dmz1] Allow ICMP from and to internal with related
        ip protocol icmp ip saddr $allInternalLans ip daddr $allInternalLans icmp type echo-request accept
        ip protocol icmp ct state related accept 

        # [Added with server-dmz1] Allow SSH from client-hq to server1-dmz
        ip protocol tcp ip saddr 192.168.10.1 ip daddr 10.0.50.1 tcp dport 22 ct state new accept 
        
        
        # [13] log any other packets for debugging and monitoring vgl. folie 69/71
        limit rate 1/second burst 5 packets log prefix "FORWARD-drop: "
	}

	chain output {
        # [14] silently drop any other packets
            type filter hook output priority filter; policy drop;
    
        # drop any invalid traffic as first measure
        ct state invalid drop
        # allow any packets belonging to existing connections
        ct state established accept
        
        # [2] [4] allow ICMP messages related to existing connections
        ip protocol icmp ct state related accept

        # [4] allow ICMP echo-requests from the firewall
        ip protocol icmp ip daddr $allInternalLans icmp type echo-request accept

        # [1] allow any traffic on loopback not to break local applications
        oifname "lo" accept

        # [5] allow DNS-Requests from fw-hq, [6] adapted for tcp AND udp
        ip protocol {udp, tcp} ip daddr $dnsServer th dport 53 ct state new accept

        # [7] allow ntp server requests from fw-hq
        ip protocol udp ip daddr @ntpServers udp dport 123 ct state new accept

        # [8] allow HTTP/HTTPS requests from int.lans, [9] adapted for HTTP3 (+udp)
        ip protocol {udp, tcp} th dport {80, 443} ct state new accept

        # [13] log any other packets for debugging and monitoring vgl. folie 69/71
        limit rate 1/second burst 5 packets log prefix "OUTPUT-drop: "
	}
}

table ip nat {
	chain nat1 { # dynamic source nat for client subnet
		type nat hook postrouting priority 0;
    meta oifname "ens33" ip saddr 192.168.10.0/24 log prefix "SNAT: 91.219.71.2" snat to 91.219.71.2;
    meta oifname "ens33" ip saddr 10.0.50.1 snat to 91.219.71.3; # ergänzt n. FW
    meta oifname "ens33" ip saddr 10.0.50.2 snat to 91.219.71.4; # ergänzt n. FW
	  }
 chain nat2 { # static dest nat for servers
		type nat hook prerouting priority 0;
    ip daddr 91.219.71.3 dnat to 10.0.50.1; # for -dmz1
    ip daddr 91.219.71.4 dnat to 10.0.50.2; # for -dmz2
	}
  chain nat3 { # for nat hairpinning
		type nat hook output priority 0;
    ip daddr 91.219.71.3 dnat to 10.0.50.1; # for -dmz1
    ip daddr 91.219.71.4 dnat to 10.0.50.2; # for -dmz2
	}
}